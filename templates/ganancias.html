{% extends "layout.html" %} {% block title %}Reporte de Ventas - Golden
Cookies{% endblock %} {% block styles %}
<style>
  /* Estilos para impresión */
  @media print {
    .no-print {
      display: none !important;
    }
    .print-only {
      display: block !important;
    }
    body {
      background-color: white !important;
      font-size: 12pt;
    }
    .print-container {
      margin: 0 !important;
      padding: 20px !important;
      width: 100% !important;
      max-width: 100% !important;
    }
    table {
      width: 100% !important;
      border-collapse: collapse !important;
    }
    table th,
    table td {
      border: 1px solid #ddd !important;
      padding: 8px !important;
    }
    a {
      text-decoration: none !important;
      color: #000 !important;
    }
    .bg-white,
    .bg-cookie-50,
    .bg-cookie-100 {
      background-color: white !important;
      box-shadow: none !important;
    }
    .shadow-md {
      box-shadow: none !important;
    }
    @page {
      size: portrait;
      margin: 1cm;
    }
    .detalle-venta-row {
      display: table-row !important;
    }
  }
  .print-only {
    display: none;
  }

  /* Estilos para filas desplegables */
  .detalle-venta-row {
    display: none;
    background-color: #fcf9f2;
  }
  .detalle-venta-row.visible {
    display: table-row;
  }
  .toggle-icon {
    transition: transform 0.3s ease;
  }
  .toggle-icon.rotate {
    transform: rotate(180deg);
  }
</style>
{% endblock %} {% block main %}
<div class="p-4 sm:ml-64">
  <div id="flash-messages" class="mb-6">
    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %} {% for category, message in messages %}
    <div
      id="flash-{{ loop.index }}"
      class="p-4 mb-4 rounded-lg flex justify-between items-center {% if category == 'success' %}bg-green-100 text-green-800{% elif category == 'danger' %}bg-red-100 text-red-800{% elif category == 'warning' %}bg-yellow-100 text-yellow-800{% else %}bg-blue-100 text-blue-800{% endif %}"
      role="alert"
    >
      <div>
        {% if category == 'success' %}
        <i class="fas fa-check-circle mr-2"></i>
        {% elif category == 'danger' %}
        <i class="fas fa-exclamation-circle mr-2"></i>
        {% elif category == 'warning' %}
        <i class="fas fa-exclamation-triangle mr-2"></i>
        {% else %}
        <i class="fas fa-info-circle mr-2"></i>
        {% endif %} {{ message }}
      </div>
      <button
        type="button"
        onclick="closeFlash('flash-{{ loop.index }}')"
        class="text-gray-500 hover:text-gray-700 focus:outline-none"
      >
        <i class="fas fa-times"></i>
      </button>
    </div>
    {% endfor %} {% endif %} {% endwith %}
  </div>
  <div class="p-4 md:p-6 lg:p-8 print-container">
    <!-- Mobile sidebar toggle -->
    <button
      type="button"
      onclick="toggleSidebar()"
      class="md:hidden inline-flex items-center p-2 mb-4 text-cookie-700 rounded-lg hover:bg-cookie-200 focus:outline-none no-print"
    >
      <i class="fas fa-bars text-lg"></i>
      <span class="ml-2">Menú</span>
    </button>

    <!-- Title and breadcrumbs -->
    <div class="mb-8">
      <div class="flex items-center mb-2 no-print">
        <a
          href="{{ url_for('venta.ventas') }}"
          class="text-cookie-600 hover:text-cookie-800"
        >
          <i class="fas fa-arrow-left mr-2"></i>Volver a Ventas
        </a>
      </div>

      <!-- Print-only header -->
      <div class="print-only text-center mb-6">
        <h1 class="text-3xl font-kavoon text-cookie-800">Golden Cookies</h1>
        <p class="text-cookie-600">Reporte de Ventas Diarias</p>
        <p class="text-sm text-cookie-500">
          Fecha: {{ fecha_seleccionada.strftime('%d/%m/%Y') }}
        </p>
      </div>

      <h1 class="text-3xl font-kavoon text-cookie-800">Reporte de Ventas</h1>
      <p class="text-cookie-600">Resumen de ganancias diarias</p>
    </div>

    <!-- Print button and date selector -->
    <div class="flex justify-between items-center mb-6 no-print">
      <button
        onclick="imprimirReporte()"
        class="bg-cookie-600 text-white py-2 px-4 rounded-md hover:bg-cookie-700 transition-colors"
      >
        <i class="fas fa-print mr-2"></i>Imprimir Reporte
      </button>

      <div class="flex items-center">
        <label for="date-selector" class="mr-2 text-cookie-700">Fecha:</label>
        <input
          type="date"
          id="date-selector"
          class="border border-cookie-300 rounded-md p-2"
          value="{{ fecha_seleccionada.strftime('%Y-%m-%d') }}"
        />
      </div>
    </div>

    <!-- Sales summary cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div
        class="bg-white rounded-lg shadow-md p-6 border-l-4 border-cookie-500"
      >
        <div class="flex justify-between items-center">
          <div>
            <p class="text-cookie-600 text-sm">Ventas Totales</p>
            <h3 class="text-2xl font-bold text-cookie-800">
              {{ total_ventas }}
            </h3>
          </div>
          <div class="bg-cookie-100 rounded-full p-3">
            <i class="fas fa-shopping-cart text-cookie-500 text-xl"></i>
          </div>
        </div>
      </div>

      <div
        class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500"
      >
        <div class="flex justify-between items-center">
          <div>
            <p class="text-cookie-600 text-sm">Ingresos</p>
            <h3 class="text-2xl font-bold text-cookie-800">
              ${{ total_cantidad }}
            </h3>
          </div>
          <div class="bg-green-100 rounded-full p-3">
            <i class="fas fa-dollar-sign text-green-500 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-cookie-600 text-sm">Promedio por Venta</p>
            <h3 class="text-2xl font-bold text-cookie-800">
              ${{ (total_cantidad / total_ventas)|round(2) if total_ventas > 0
              else 0 }}
            </h3>
          </div>
          <div class="bg-blue-100 rounded-full p-3">
            <i class="fas fa-chart-line text-blue-500 text-xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Sales table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
      <div class="p-6 bg-cookie-50 border-b border-cookie-200">
        <h2 class="text-xl font-kavoon text-cookie-700">Detalle de Ventas</h2>
        <p class="text-sm text-cookie-500">
          {{ fecha_seleccionada.strftime('%d/%m/%Y') }}
        </p>
      </div>

      {% if ventas|length > 0 %}
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-left">
          <thead class="text-xs text-cookie-700 uppercase bg-cookie-100">
            <tr>
              <th class="px-4 py-3 w-10"></th>
              <th class="px-4 py-3">No.</th>
              <th class="px-4 py-3">Tipo</th>
              <th class="px-4 py-3">Vendedor</th>
              <th class="px-4 py-3">Hora</th>
              <th class="px-4 py-3">Total</th>
            </tr>
          </thead>
          <tbody>
            {% for venta in ventas %}
            <tr class="border-b border-cookie-200 hover:bg-cookie-50">
              <td class="px-4 py-3">
                <button
                  type="button"
                  onclick="toggleDetalles('detalle-{{ venta.id_venta }}')"
                  class="text-cookie-700 hover:text-cookie-900"
                >
                  <i
                    class="fas fa-chevron-down toggle-icon"
                    id="icon-{{ venta.id_venta }}"
                  ></i>
                </button>
              </td>
              <td class="px-4 py-3">#{{ venta.id_venta }}</td>
              <td class="px-4 py-3">
                {% if venta.tipo_venta == 'local' %}
                <span
                  class="px-2 py-1 text-xs font-medium bg-cookie-200 text-cookie-800 rounded-full"
                  >Local</span
                >
                {% else %}
                <span
                  class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full"
                  >Online</span
                >
                {% endif %}
              </td>
              <td class="px-4 py-3">{{ venta.usuario.nombre }}</td>
              <td class="px-4 py-3">
                {{ venta.created_at.strftime('%H:%M') }}
              </td>
              <td class="px-4 py-3 font-medium">${{ venta.total }}</td>
            </tr>

            <!-- Fila desplegable para detalles de la venta -->
            <tr id="detalle-{{ venta.id_venta }}" class="detalle-venta-row">
              <td colspan="6" class="px-6 py-4">
                <div class="bg-white p-4 rounded-lg border border-cookie-200">
                  <div class="mb-4">
                    <h4 class="font-semibold text-cookie-700 mb-2">
                      Información de la Venta:
                    </h4>
                    <p><strong>Vendedor:</strong> {{ venta.usuario.nombre }}</p>
                    <p>
                      <strong>Fecha:</strong> {{
                      venta.created_at.strftime('%d/%m/%Y %H:%M') }}
                    </p>
                    <p><strong>Tipo:</strong> {{ venta.tipo_venta }}</p>
                    <p><strong>Total:</strong> ${{ venta.total }}</p>
                  </div>

                  <h4 class="font-semibold text-cookie-700 mb-2">Productos:</h4>
                  <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                      <thead class="text-xs uppercase bg-cookie-100">
                        <tr>
                          <th class="px-3 py-2 text-left">Galleta</th>
                          <th class="px-3 py-2 text-left">Tipo</th>
                          <th class="px-3 py-2 text-left">Cantidad</th>
                          <th class="px-3 py-2 text-left">Precio</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for detalle in venta.detalle_venta %}
                        <tr class="border-b border-cookie-200">
                          <td class="px-3 py-2">
                            {{ detalle.galleta.nombre }}
                          </td>
                          <td class="px-3 py-2">{{ detalle.tipo_venta }}</td>
                          <td class="px-3 py-2">{{ detalle.cantidad }}</td>
                          <td class="px-3 py-2">
                            ${{ detalle.precio_unitario }}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="font-semibold bg-cookie-50">
              <td></td>
              <td colspan="4" class="px-4 py-3 text-right">Total:</td>
              <td class="px-4 py-3">${{ total_cantidad }}</td>
            </tr>
          </tfoot>
        </table>
      </div>
      {% else %}
      <div class="text-center py-12 text-cookie-600">
        <i class="fas fa-receipt text-5xl mb-4"></i>
        <p>No hay ventas registradas para hoy</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  // Date selector functionality
  document
    .getElementById("date-selector")
    .addEventListener("change", function () {
      const selectedDate = this.value;
      // Construir la URL base y añadir el parámetro de fecha
      const baseUrl = "{{ url_for('venta.ganancias') }}";
      const separator = baseUrl.includes("?") ? "&" : "?";

      // Redireccionar con la URL correcta
      window.location.href = baseUrl + separator + "fecha=" + selectedDate;
    });

  // Toggle detalles de venta
  function toggleDetalles(detalleId) {
    const detalleRow = document.getElementById(detalleId);
    const iconId = "icon-" + detalleId.split("-")[1];
    const icon = document.getElementById(iconId);

    if (detalleRow) {
      detalleRow.classList.toggle("visible");
      if (icon) {
        icon.classList.toggle("rotate");
      }
    }
  }

  // Función para imprimir
  function imprimirReporte() {
    // Mostrar todos los detalles al imprimir
    const detalleRows = document.querySelectorAll(".detalle-venta-row");
    detalleRows.forEach((row) => {
      // Añadir una clase en lugar de cambiar display
      // para que los estilos de impresión puedan sobrescribirlo
      row.classList.add("visible");
    });

    // Ejecutar la impresión
    window.print();

    // Restaurar estado original
    setTimeout(() => {
      detalleRows.forEach((row) => {
        if (!row.classList.contains("visible-before-print")) {
          row.classList.remove("visible");
        }
      });
    }, 1000);
  }

  // Cerrar mensaje flash
  function closeFlash(id) {
    const flashElement = document.getElementById(id);
    if (flashElement) {
      flashElement.style.opacity = "0";
      setTimeout(() => {
        flashElement.style.display = "none";
      }, 300);
    }
  }

  // Cerrar mensajes flash automáticamente después de 5 segundos
  document.addEventListener("DOMContentLoaded", function () {
    const flashMessages = document.querySelectorAll('[id^="flash-"]');
    flashMessages.forEach((message) => {
      // Añadir transición para efecto de desvanecimiento
      message.style.transition = "opacity 0.3s ease";

      // Cerrar automáticamente después de 5 segundos
      setTimeout(() => {
        closeFlash(message.id);
      }, 5000);
    });
  });

  // Adaptar la vista de impresión si se usa el atajo de teclado
  window.addEventListener("keydown", function (e) {
    // Ctrl+P o Cmd+P
    if ((e.ctrlKey || e.metaKey) && e.key === "p") {
      imprimirReporte();
      e.preventDefault();
    }
  });
</script>
{% endblock %}
