<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flowbite Flask</title>
    <link
      rel="stylesheet"
      href="{{url_for('static',filename='css/output.css')}}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="{{url_for('static',filename='css/style.css')}}"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@400;700&family=Dancing+Script:wght@400..700&family=Kavoon&family=Parisienne&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <header class="encabezado">
      <a href="../index.html">
        <img src="../static/img/logo_goldenCookies.jpeg" class="logo" />
      </a>
    </header>
    <div class="flash-messages container">
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, message in messages %}
      <div
        class="alert alert-{{ category }} alert-dismissible fade show"
        role="alert"
      >
        {{ message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Cerrar"
        ></button>
      </div>
      {% endfor %} {% endif %} {% endwith %}
    </div>
    <div class="container mt-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Detalle de Producción #{{ produccion.id_produccion }}</h1>
        <a href="{{ url_for('produccion.index') }}" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i> Volver
        </a>
      </div>

      <div class="card mb-4">
        <div class="card-header">
          <h5>Información General</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
              <p>
                <strong>Galleta:</strong> {{ produccion.receta.galleta.nombre }}
              </p>
              <p>
                <strong>Cantidad a producir:</strong> {{
                produccion.receta.cantidad_produccion }} unidades
              </p>
            </div>
            <div class="col-md-4">
              <p>
                <strong>Responsable:</strong> {{ produccion.usuario.nombre }}
              </p>
              <p>
                <strong>Fecha creación:</strong> {{
                produccion.created_at.strftime('%d/%m/%Y %H:%M') }}
              </p>
            </div>
            <div class="col-md-4">
              <p>
                <strong>Estatus:</strong>
                {% if produccion.estatus == 'programada' %}
                <span class="badge badge-secondary">Programada</span>
                {% elif produccion.estatus == 'en_proceso' %}
                <span class="badge badge-primary">En Proceso</span>
                {% elif produccion.estatus == 'completada' %}
                <span class="badge badge-success">Completada</span>
                {% elif produccion.estatus == 'cancelada' %}
                <span class="badge badge-danger">Cancelada</span>
                {% endif %}
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header">
          <h5>Insumos Requeridos por la Receta</h5>
        </div>
        <div class="card-body">
          {% if produccion.estatus == 'programada' and not insumos_disponibles
          %}
          <div class="alert alert-danger mb-3">
            <strong>¡Atención!</strong> No hay suficientes insumos disponibles
            para iniciar esta producción:
            <ul class="mb-0 mt-2">
              {% for insumo in insumos_insuficientes %}
              <li>
                {{ insumo.nombre }}: se requiere {{ insumo.requerido }} {{
                insumo.unidad }} pero solo hay {{ insumo.disponible }}
                disponible
              </li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}

          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Insumo</th>
                  <th>Cantidad Requerida</th>
                  <th>Unidad</th>
                  {% if produccion.estatus == 'completada' %} {% else %}
                  <th>Disponibilidad</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% for receta_insumo in produccion.receta.receta_insumo %} {%
                set insumo_usado = [] %} {% for insumo in insumos_usados %} {%
                if insumo.lote_insumo.id_insumo == receta_insumo.id_insumo %} {%
                set _ = insumo_usado.append(insumo) %} {% endif %} {% endfor %}
                <tr>
                  <td>{{ receta_insumo.insumo.nombre }}</td>
                  <td>{{ receta_insumo.cantidad_insumo }}</td>
                  <td>{{ receta_insumo.insumo.unidad_medida }}</td>
                  {% if produccion.estatus == 'completada' %} {% else %}
                  <td>
                    {% if produccion.estatus == 'completada' %} {% set
                    cantidad_usada =
                    insumo_usado|map(attribute='cantidad_usada')|sum %} {{
                    ((cantidad_usada / receta_insumo.cantidad_insumo) *
                    100)|round(2) }}% {% else %} {% if
                    receta_insumo.insumo.cantidad_insumo >=
                    receta_insumo.cantidad_insumo %}
                    <span class="badge badge-success">Suficiente</span>
                    {% else %}
                    <span class="badge badge-danger">Insuficiente</span>
                    <small
                      >({{ receta_insumo.insumo.cantidad_insumo }} de {{
                      receta_insumo.cantidad_insumo }} {{
                      receta_insumo.insumo.unidad_medida }})</small
                    >
                    {% endif %} {% endif %}
                  </td>
                  {% endif %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {% if insumos_usados or produccion.estatus == 'completada' %}
      <div class="card mb-4">
        <div class="card-header">
          <h5>Insumos Utilizados</h5>
        </div>
        <div class="card-body">
          {% if insumos_usados %}
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Insumo</th>
                  <th>Lote</th>
                  <th>Cantidad Usada</th>
                  <th>Unidad</th>
                  <th>Costo Unitario</th>
                  <th>Subtotal</th>
                </tr>
              </thead>
              <tbody>
                {% for insumo in insumos_usados %}
                <tr>
                  <td>{{ insumo.lote_insumo.insumo.nombre }}</td>
                  <td>Lote #{{ insumo.lote_insumo.id_lote_insumo }}</td>
                  <td>{{ insumo.cantidad_usada }}</td>
                  <td>{{ insumo.lote_insumo.insumo.unidad_medida }}</td>
                  <td>
                    ${{ "%.2f"|format(insumo.lote_insumo.costo_unitario) }}
                  </td>
                  <td>
                    ${{ "%.2f"|format(insumo.cantidad_usada *
                    insumo.lote_insumo.costo_unitario) }}
                  </td>
                </tr>
                {% endfor %}
                <tr class="table-info">
                  <td colspan="5" class="text-right">
                    <strong>Total:</strong>
                  </td>
                  <td><strong>${{ "%.2f"|format(costo_total) }}</strong></td>
                </tr>
              </tbody>
            </table>
          </div>
          {% elif produccion.estatus == 'completada' %}
          <div class="alert alert-info">
            Los insumos han sido utilizados automáticamente según la receta.
          </div>
          {% else %}
          <div class="alert alert-info">
            Los insumos serán utilizados automáticamente al finalizar la
            producción.
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %} {% if produccion.estatus == 'completada' and lote_galleta %}
      <div class="card mb-4">
        <div class="card-header">
          <h5>Lote de Galletas Producidas</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
              <p>
                <strong>Cantidad producida:</strong> {{
                lote_galleta.cantidad_inicial }} unidades
              </p>
              <p>
                <strong>Costo unitario:</strong> ${{
                "%.2f"|format(lote_galleta.costo_unitario) }}
              </p>
            </div>
            <div class="col-md-4">
              <p>
                <strong>Precio de venta:</strong> ${{
                "%.2f"|format(lote_galleta.precio_venta) }}
              </p>
              <p>
                <strong>Margen de ganancia:</strong> {{
                ((lote_galleta.precio_venta - lote_galleta.costo_unitario) /
                lote_galleta.costo_unitario * 100)|round(2) }}%
              </p>
            </div>
            <div class="col-md-4">
              <p>
                <strong>Fecha producción:</strong> {{
                lote_galleta.fecha_produccion.strftime('%d/%m/%Y') }}
              </p>
              <p>
                <strong>Fecha caducidad:</strong> {{
                lote_galleta.fecha_caducidad.strftime('%d/%m/%Y') }}
              </p>
            </div>
          </div>
        </div>
      </div>
      {% endif %} {% if mermas %}
      <div class="card">
        <div class="card-header">
          <h5>Mermas Registradas</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th>Material</th>
                  <th>Cantidad</th>
                  <th>Fecha</th>
                  <th>Motivo</th>
                </tr>
              </thead>
              <tbody>
                {% for merma in mermas %}
                <tr>
                  <td>
                    {% if merma.tipo_merma == 'caducidad' %}
                    <span class="badge badge-warning">Caducidad</span>
                    {% elif merma.tipo_merma == 'daño' %}
                    <span class="badge badge-danger">Daño</span>
                    {% elif merma.tipo_merma == 'contaminación' %}
                    <span class="badge badge-danger">Contaminación</span>
                    {% elif merma.tipo_merma == 'error_proceso' %}
                    <span class="badge badge-info">Error en Proceso</span>
                    {% elif merma.tipo_merma == 'rotura' %}
                    <span class="badge badge-secondary">Rotura</span>
                    {% elif merma.tipo_merma == 'calidad' %}
                    <span class="badge badge-primary">Control Calidad</span>
                    {% else %}
                    <span class="badge badge-light">Otro</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if merma.id_lote_insumo %} {{
                    merma.lote_insumo.insumo.nombre }} (Insumo) {% elif
                    merma.id_lote_galleta %} {{
                    merma.lote_galleta.galleta.nombre }} (Galleta) {% endif %}
                  </td>
                  <td>
                    {{ merma.cantidad }} {% if merma.id_lote_insumo %} {{
                    merma.lote_insumo.insumo.unidad_medida }} {% else %}
                    unidades {% endif %}
                  </td>
                  <td>{{ merma.fecha_registro.strftime('%d/%m/%Y %H:%M') }}</td>
                  <td>{{ merma.motivo or 'N/A' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}

      <div class="mt-4">
        {% if produccion.estatus == 'programada' %}
        <form
          method="POST"
          action="{{ url_for('produccion.iniciar', id=produccion.id_produccion) }}"
          class="d-inline"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <button
            type="submit"
            class="btn btn-success mr-2"
            {%
            if
            not
            insumos_disponibles
            %}disabled{%
            endif
            %}
          >
            <i class="fas fa-play"></i> Iniciar Producción
          </button>
          {% if not insumos_disponibles %}
          <small class="text-danger"
            >No hay suficientes insumos para iniciar esta producción</small
          >
          {% endif %}
        </form>
        <form
          method="POST"
          action="{{ url_for('produccion.cancelar', id=produccion.id_produccion) }}"
          class="d-inline"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <button
            type="submit"
            class="btn btn-danger"
            onclick="return confirm('¿Estás seguro de cancelar esta producción?')"
          >
            <i class="fas fa-times"></i> Cancelar Producción
          </button>
        </form>
        {% elif produccion.estatus == 'en_proceso' %}
        <form
          method="POST"
          action="{{ url_for('produccion.finalizar', id=produccion.id_produccion) }}"
          class="d-inline"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <button type="submit" class="btn btn-success mr-2">
            <i class="fas fa-check"></i> Finalizar Producción
          </button>
          <small class="text-muted"
            >Al finalizar, los insumos se tomarán automáticamente del
            inventario</small
          >
        </form>
        {% endif %}
      </div>
    </div>
  </body>
</html>
