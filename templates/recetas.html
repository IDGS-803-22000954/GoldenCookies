<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recetas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kavoon&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../static/css/recetas.css">
</head>
<body>
    <header class="encabezado">
        <div class="container d-flex justify-content-between align-items-center">
            <a href="../index.html">
                <img src="../static/img/logo_goldenCookies.jpg" alt="Logo" class="logo">
            </a>
        </div>
    </header>

    <div class="container my-5">
        <div class="text-center">
            <img src="../static/img/libro-de-cocina.png" alt="Receta" class="icono">
            <h1 class="display-4 fw-bold">Recetas</h1>
        </div>
        <div class="text-center mt-4">
            <button class="btn btn-warning text-white fw-bold" id="btnAgregarReceta">
                <i class="fas fa-plus"></i> Agregar Receta
            </button>
        </div>

        <!-- Formulario para agregar receta -->
        <div id="formAgregar" class="mt-4" style="display: none;">
            <h5>Agregar Receta</h5>
            <form id="agregarForm" method="POST" action="{{ url_for('recetas.insertar_receta') }}" enctype="multipart/form-data">
                {{ form.hidden_tag() }}
                <label>Nombre:</label>
                <input type="text" class="form-control" name="nombre" required>

                <label>Detalles de la receta:</label>
                <textarea class="form-control" name="detalles" required></textarea>

                <label>Cantidad Producida:</label>
                <input type="number" class="form-control" name="cantidad_produccion" required>

                <label>Peso por unidad(gr):</label>
                <input type="number" class="form-control" name="peso_unidad" required>

                <label>Descripción de la galleta</label>
                <textarea class="form-control" name="descripcion" required></textarea>

                <label>Imagen de la Galleta:</label>
                <input type="file" class="form-control" name="imagen_galleta" accept="image/*">

                <label>Insumos:</label>
                <div id="insumosContainer">
                    {% for insumo in insumos %}
                        <div>
                            <input type="checkbox" name="insumo_{{ insumo.id_insumo }}" data-id="{{ insumo.id_insumo }}">
                            <label>{{ insumo.nombre }} ({{ insumo.unidad_medida }})</label>
                            <input type="number" step="any" name="cantidad_{{ insumo.id_insumo }}" disabled>
                        </div>
                    {% endfor %}
                </div>

                <button type="submit" class="btn btn-primary">Guardar</button>
                <button type="button" class="btn btn-secondary" id="btnCancelarAgregar">Cancelar</button>
            </form>
        </div>

        <!-- Formulario para modificar receta -->
        <div id="formModificar" class="mt-4" style="display: none;">
            <h5>Modificar Receta</h5>
            <form id="modificarForm" method="POST" action="" enctype="multipart/form-data">
                {{ form.hidden_tag() }}
                <input type="hidden" name="id_receta" id="modificarId">

                <label>Nombre:</label>
                <input type="text" class="form-control" name="nombre" id="modificarNombre" required>

                <label>Detalles de la receta:</label>
                <textarea class="form-control" name="detalles" id="modificarDescripcion" required></textarea>

                <label>Cantidad Producida:</label>
                <input type="number" class="form-control" name="cantidad_produccion" id="modificarCantidad" required>

                <label>Peso por unidad(gr):</label>
                <input type="number" class="form-control" name="peso_unidad" id="modificarPesoUnidad" required>

                <label>Descripción de la galleta</label>
                <textarea class="form-control" name="descripcion_galleta" id="modificarDescripcionGalleta" required></textarea>

                <label>Imagen de la Galleta:</label>
                <input type="file" class="form-control" name="imagen_galleta" accept="image/*">

                <label>Insumos:</label>
                <div id="modificarInsumosContainer"></div>

                <button type="submit" class="btn btn-primary">Guardar</button>
                <button type="button" class="btn btn-secondary" id="btnCancelarModificar">Cancelar</button>
            </form>
        </div>

        <!-- Tabla de recetas -->
        <table class="table mt-4">
            <thead>
                <tr>
                    <th>Receta</th>
                    <th>Detalles</th>
                    <th>Cantidad</th>
                    <th>Galleta</th>
                    <th>Precio por galleta</th>
                    <th>Peso por galletas(gr)</th>
                    <th>Descripción de la galleta</th>
                    <th>Imagen</th> <!-- Nueva columna para la imagen -->
                    <th>Insumos</th>
                    <th>Modificar</th>
                </tr>
            </thead>
            <tbody>
                {% for receta in recetas %}
                <tr>
                    <td>{{ receta.nombre }}</td>
                    <td>{{ receta.detalles }}</td>
                    <td>{{ receta.cantidad_produccion }}</td>
                    <td>{{ receta.galleta.nombre }}</td>
                    <td>{{ receta.galleta.precio }}</td>
                    <td>{{ receta.galleta.peso_unidad }}</td>
                    <td>{{ receta.galleta.descripcion }}</td>
                    <td>
                        {% if receta.galleta.imagen %}
                            <img src="{{ url_for('static', filename='uploads/' + receta.galleta.imagen) }}" alt="Imagen de la Galleta" style="max-width: 100px; max-height: 100px;">
                        {% else %}
                            <p>No imagen</p>
                        {% endif %}
                    </td>
                    <td>
                        <ul>
                            {% for ri in receta.receta_insumo %}
                                <li>{{ ri.insumo.nombre }}: {{ ri.cantidad_insumo }} {{ ri.insumo.unidad_medida }}</li>
                            {% endfor %}
                        </ul>
                    </td>
                    <td>
                        <button class="btn btn-primary btnModificar" data-id="{{ receta.id_receta }}">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        document.getElementById('btnAgregarReceta').addEventListener('click', function() {
            document.getElementById('formAgregar').style.display = 'block';
            document.getElementById('formModificar').style.display = 'none';
        });

        document.getElementById('btnCancelarAgregar').addEventListener('click', function() {
            document.getElementById('formAgregar').style.display = 'none';
        });

        document.getElementById('btnCancelarModificar').addEventListener('click', function() {
            document.getElementById('formModificar').style.display = 'none';
        });

        document.querySelectorAll('.btnModificar').forEach(button => {
            button.addEventListener('click', function() {
                let idReceta = this.getAttribute('data-id');
                let formModificar = document.getElementById('modificarForm');
                formModificar.action = `/recetas/modificar/${idReceta}`;

                fetch(`/recetas/modificar/${idReceta}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('modificarId').value = idReceta;
                        document.getElementById('modificarNombre').value = data.nombre;
                        document.getElementById('modificarDescripcion').value = data.descripcion;
                        document.getElementById('modificarCantidad').value = data.cantidad_produccion;
                        document.getElementById('modificarPesoUnidad').value = data.peso_unidad;

                        let insumosContainer = document.getElementById('modificarInsumosContainer');
                        insumosContainer.innerHTML = '';

                        // Cargar insumos existentes
                        data.insumos.forEach(insumo => {
                            let div = document.createElement('div');
                            div.innerHTML =
                                `<input type="checkbox" name="insumo_${insumo.id_insumo}" checked>
                                <label>${insumo.nombre} (${insumo.unidad_medida})</label>
                                <input type="number" step="any" name="cantidad_${insumo.id_insumo}" value="${insumo.cantidad}">`;
                            insumosContainer.appendChild(div);
                        });

                        if (data.imagen) {
                        let imagenPreview = document.createElement('img');
                        imagenPreview.src = `/static/uploads/${data.imagen}`;
                        imagenPreview.style.maxWidth = '200px';
                        imagenPreview.style.maxHeight = '200px';
                        document.getElementById('modificarForm').prepend(imagenPreview);
                }


                        document.getElementById('formModificar').style.display = 'block';
                        document.getElementById('formAgregar').style.display = 'none';
                    })
                    .catch(error => console.error('Error al cargar receta:', error));
            });
        });

        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                let cantidadInput = this.nextElementSibling.nextElementSibling;
                if (this.checked) {
                    cantidadInput.disabled = false;
                } else {
                    cantidadInput.disabled = true;
                    cantidadInput.value = '';
                }
            });
        });
    </script>
</body>
</html>