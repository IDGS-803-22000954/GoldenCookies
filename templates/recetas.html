
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recetas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kavoon&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../static/css/recetas.css">
</head>
<body>
    <header class="encabezado">
        <div class="container d-flex justify-content-between align-items-center">
            <a href="../index.html">
                <img src="../static/img/logo_goldenCookies.jpg" alt="Logo" class="logo">
            </a>
        </div>
    </header>

    <div class="container my-5">
        <div class="text-center">
            <img src="../static/img/libro-de-cocina.png" alt="Receta" class="icono">
            <h1 class="display-4 fw-bold">Recetas</h1>
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div style="margin: 0px 40px 0px 40px;">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}
        <div class="text-center mt-4">
            <button class="btn btn-warning text-white fw-bold" id="btnAgregarReceta">
                <i class="fas fa-plus"></i> Agregar Receta
            </button>
        </div>

        <!-- Formulario para agregar receta -->
        <div id="formAgregar" class="formulario mt-4" style="display: none;">
            <h5>Agregar Receta</h5>
            <form id="agregarForm" method="POST" action="{{ url_for('recetas.insertar_receta') }}" enctype="multipart/form-data">
                {{ form.hidden_tag() }}
                <label>Nombre:</label>
                <input type="text" class="form-control" name="nombre" required>

                <label>Detalles de la receta:</label>
                <textarea class="form-control" name="detalles" required></textarea>

                <label>Cantidad Producida:</label>
                <input type="number" class="form-control" name="cantidad_produccion" required>

                <label>Peso por unidad(gr):</label>
                <input type="number" class="form-control" name="peso_unidad" required>

                <label>Descripción de la galleta</label>
                <textarea class="form-control" name="descripcion" required></textarea>

                <label>Imagen de la Galleta:</label>
                <input type="file" class="form-control" name="imagen_galleta" accept="image/*">

                <label>Insumos:</label>
                <div id="insumosContainer">
                    {% for insumo in insumos %}
                        <div>
                            <input type="checkbox" name="insumo_{{ insumo.id_insumo }}" data-id="{{ insumo.id_insumo }}">
                            <label>{{ insumo.nombre }} ({{ insumo.unidad_medida }})</label>
                            <input type="number" step="any" name="cantidad_{{ insumo.id_insumo }}" disabled>
                        </div>
                    {% endfor %}
                </div>

                <button type="submit" class="btn btn-primary">Guardar</button>
                <button type="button" class="btn btn-secondary" id="btnCancelarAgregar">Cancelar</button>
            </form>
        </div>

        <!-- Formulario para modificar receta -->
        <div id="formModificar" class="formulario mt-4" style="display: none;">
            <h5>Modificar Receta</h5>
            <form id="modificarForm" method="POST" action="" enctype="multipart/form-data">
                {{ form.hidden_tag() }}
                <input type="hidden" name="id_receta" id="modificarId">

                <label>Nombre:</label>
                <input type="text" class="form-control" name="nombre" id="modificarNombre" required>

                <label>Detalles de la receta:</label>
                <textarea class="form-control" name="detalles" id="modificarDescripcion" required></textarea>

                <label>Cantidad Producida:</label>
                <input type="number" class="form-control" name="cantidad_produccion" id="modificarCantidad" required>

                <label>Peso por unidad(gr):</label>
                <input type="number" class="form-control" name="peso_unidad" id="modificarPesoUnidad" required>

                <label>Descripción de la galleta</label>
                <textarea class="form-control" name="descripcion_galleta" id="modificarDescripcionGalleta" required></textarea>

                <label>Imagen de la Galleta:</label>
                <input type="file" class="form-control" name="imagen_galleta" accept="image/*">

                <label>Insumos:</label>
                <div id="modificarInsumosContainer"></div>

                <button type="submit" class="btn btn-primary">Guardar</button>
                <button type="button" class="btn btn-secondary" id="btnCancelarModificar">Cancelar</button>
            </form>
        </div>

        <!-- Cards de recetas -->
    <div class="row mt-4">
        {% for receta in recetas %}
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <!-- Imagen de la galleta -->
                {% if receta.galleta.imagen %}
                <img src="{{ url_for('static', filename='uploads/' + receta.galleta.imagen) }}" 
                     class="card-img-top" 
                     alt="{{ receta.galleta.nombre }}"
                     style="height: 200px; object-fit: cover;">
                {% else %}
                <div class="card-img-top bg-light d-flex align-items-center justify-content-center" 
                     style="height: 200px;">
                    <i class="fas fa-cookie fa-5x text-secondary"></i>
                </div>
                {% endif %}
                
                <div class="card-body">
                    <h5 class="card-title">{{ receta.nombre }}</h5>
                    <p class="card-text">
                        <strong>Producción:</strong> {{ receta.cantidad_produccion }} unidades<br>
                        <strong>Peso por galleta:</strong> {{ receta.galleta.peso_unidad }} gr
                    </p>
                </div>
                
                <div class="card-footer bg-white">
                    <div class="d-flex justify-content-between">
                        <!-- Botón para ver detalles de la receta -->
                        <button class="btn btn-outline-primary btn-sm" 
                                data-bs-toggle="modal" 
                                data-bs-target="#modalDetalles{{ receta.id_receta }}">
                            <i class="fas fa-book-open"></i> Receta
                        </button>
                        
                        <!-- Botón para ver detalles de la galleta -->
                        <button class="btn btn-outline-info btn-sm" 
                                data-bs-toggle="modal" 
                                data-bs-target="#modalGalleta{{ receta.id_receta }}">
                            <i class="fas fa-cookie"></i> Galleta
                        </button>
                        
                        <!-- Botón para modificar -->
                        <button class="btn btn-outline-warning btn-sm btnModificar" 
                                data-id="{{ receta.id_receta }}">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para detalles de la receta -->
        <div class="modal fade" id="modalDetalles{{ receta.id_receta }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Detalles de la receta: {{ receta.nombre }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h6>Instrucciones:</h6>
                        <p>{{ receta.detalles }}</p>
                        
                        <h6 class="mt-3">Insumos utilizados:</h6>
                        <ul>
                            {% for ri in receta.receta_insumo %}
                            <li>{{ ri.insumo.nombre }}: {{ ri.cantidad_insumo }} {{ ri.insumo.unidad_medida }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para detalles de la galleta -->
        <div class="modal fade" id="modalGalleta{{ receta.id_receta }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Detalles de la galleta: {{ receta.galleta.nombre }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            {% if receta.galleta.imagen %}
                            <div class="col-md-6">
                                <img src="{{ url_for('static', filename='uploads/' + receta.galleta.imagen) }}" 
                                     class="img-fluid rounded" 
                                     alt="{{ receta.galleta.nombre }}">
                            </div>
                            {% endif %}
                            <div class="col-md-{% if receta.galleta.imagen %}6{% else %}12{% endif %}">
                                <p><strong>Precio:</strong> ${{ receta.galleta.precio }}</p>
                                <p><strong>Peso por unidad:</strong> {{ receta.galleta.peso_unidad }} gr</p>
                                <p><strong>Descripción:</strong></p>
                                <p>{{ receta.galleta.descripcion }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
    </div>

    <script>
        document.getElementById('btnAgregarReceta').addEventListener('click', function() {
            document.getElementById('formAgregar').style.display = 'block';
            document.getElementById('formModificar').style.display = 'none';
        });

        document.getElementById('btnCancelarAgregar').addEventListener('click', function() {
            document.getElementById('formAgregar').style.display = 'none';
        });

        document.getElementById('btnCancelarModificar').addEventListener('click', function() {
            document.getElementById('formModificar').style.display = 'none';
        });

        
        document.querySelectorAll('.btnModificar').forEach(button => {
    button.addEventListener('click', function() {
        let idReceta = this.getAttribute('data-id');
        let formModificar = document.getElementById('modificarForm');
        formModificar.action = `/recetas/modificar/${idReceta}`;

        fetch(`/recetas/modificar/${idReceta}`)
            .then(response => response.json())
            .then(data => {
                // Llenar datos de la receta
                document.getElementById('modificarId').value = idReceta;
                document.getElementById('modificarNombre').value = data.receta.nombre;
                document.getElementById('modificarDescripcion').value = data.receta.detalles;
                document.getElementById('modificarCantidad').value = data.receta.cantidad_produccion;
                
                // Llenar datos de la galleta
                document.getElementById('modificarPesoUnidad').value = data.galleta.peso_unidad;
                document.getElementById('modificarDescripcionGalleta').value = data.galleta.descripcion;

                // Limpiar el contenedor de insumos
                let insumosContainer = document.getElementById('modificarInsumosContainer');
                insumosContainer.innerHTML = '';

                // Cargar insumos existentes
                data.insumos.forEach(insumo => {
                    let div = document.createElement('div');
                    div.className = 'mb-2';
                    div.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="insumo_${insumo.id_insumo}" 
                                   id="insumo_${insumo.id_insumo}" checked>
                            <label class="form-check-label" for="insumo_${insumo.id_insumo}">
                                ${insumo.nombre} (${insumo.unidad_medida})
                            </label>
                        </div>
                        <input type="number" class="form-control" step="any" 
                               name="cantidad_${insumo.id_insumo}" 
                               value="${insumo.cantidad}">`;
                    insumosContainer.appendChild(div);
                });

                // Mostrar vista previa de la imagen si existe
                let existingPreview = document.querySelector('#modificarForm img');
                if (existingPreview) {
                    existingPreview.remove();
                }
                
                if (data.galleta.imagen) {
                    let imagenPreview = document.createElement('img');
                    imagenPreview.src = `/static/uploads/${data.galleta.imagen}`;
                    imagenPreview.className = 'img-thumbnail mb-3';
                    imagenPreview.style.maxWidth = '200px';
                    imagenPreview.style.maxHeight = '200px';
                    imagenPreview.alt = 'Imagen actual';
                    
                    // Insertar después del título "Modificar Receta"
                    let title = document.querySelector('#formModificar h5');
                    title.parentNode.insertBefore(imagenPreview, title.nextSibling);
                    
                    // Agregar texto "Imagen actual"
                    let currentImageText = document.createElement('p');
                    currentImageText.textContent = 'Imagen actual:';
                    title.parentNode.insertBefore(currentImageText, imagenPreview);
                }

                // Mostrar el formulario de modificación
                document.getElementById('formModificar').style.display = 'block';
                document.getElementById('formAgregar').style.display = 'none';
            })
            .catch(error => console.error('Error al cargar receta:', error));
    });
});

        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                let cantidadInput = this.nextElementSibling.nextElementSibling;
                if (this.checked) {
                    cantidadInput.disabled = false;
                } else {
                    cantidadInput.disabled = true;
                    cantidadInput.value = '';
                }
            });
        });
    </script>

<!-- JS de Bootstrap y Popper.js (necesario para los modales) -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>

</body>
</html>
